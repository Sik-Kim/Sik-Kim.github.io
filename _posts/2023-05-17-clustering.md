---
title: "지오해시로 간단하고 쉽게 클러스터링 적용하기"
date: 2023-05-17 23:00:00 -0400
summary:
toc: ture
toc_sticky: true
comments: true
tag:
    - 지도
    - postgresql
    - typescript
    - clustering
category:
    - clustering
---

2년간 지도 서비스를 개발/운영하면서 클러스터링에 대한 고민도 정말 많았었다. <br>
여러가지 시도 끝에 서비스에 최적인 방법을 결국 찾았는데 지오해시를 이용한 방법이다. <br>
이는 개발이 그렇게 어렵지 않고 빠르며 데이터 관리도 효율적이다.

<img src="https://github.com/Sik-Kim/Sik-Kim.github.io/assets/63498876/111c9a45-8955-4eda-bbd4-41bf3efadc8e" width="100%" height="100%">

<br>

## 클러스터링

클러스터링의 사전적 의미는 유사한 특성을 가진 데이터를 집단으로 새롭게 정의하는 것을 의미한다. <br>
쉽게 설명하면 수 많은 데이터를 그룹화해서 한눈에 편하게 보기 위함이다. <br>
주로 지도 서비스에서 많이 사용한다.

<br>

## 지오해시(Geohash)

지오해시는 위치를 값으로 표시하는 방법이다. <br>
위치를 어떻게 구분할지나 어떤 값을 부여할지는 개발 상황에 따라 다를 것이다.

<img src="https://github.com/Sik-Kim/Sik-Kim.github.io/assets/63498876/c2a7edc4-0010-4be9-a7f1-6b2499e116ab" width="100%" height="100%">

 <br>

## 4등분 지오해시(Geohash)

딱히 이름을 어떻게 지어야할지 모르겠어서 4등분 지오해시라고 명했다. <br>
내가 적용한 방법이 지도를 계속해서 4등분으로 쪼개는 방법이다.

1 아래 전국 지도를 보면 정사각형을 4등분으로 쪼개면 4개의 면이 만들어지고 각 면에 0~3을 붙인다. (4등분을 1번 하면 지오해시 값은 1자리가 된다.) <br>
나눠진 정사각형을 한번 더 4등분으로 나눈다. (4등분을 총 2번 했고 이제 지오해시 값은 2자리가 된다.) <br>

즉 4등분을 한번씩 할 때마다 지오해시값이 1자리씩 증가하게 된다. <br>
난 이런식으로 전국에 4등분을 총 15번해서 15자리의 지오해시 값을 만들었다. <br>

<img src="https://github.com/Sik-Kim/Sik-Kim.github.io/assets/63498876/7cb429d3-51b6-443f-b8fd-4fe1c0fbac6a" width="100%" height="100%">

 <br>

## 좌표를 지오해시 값으로 치환하기

좌표 데이터가 있다면 지오해시 값으로 치환해주면 된다. <br>
내가 개발중인 오픈닥터 서비스에는 10만개 이상의 의원 좌표가 있는데 모두 지오해시 값으로 치환하여 db에 저장했다.

의원 좌표와 정사각형의 가운데 위치를 비교하며 0~3 값을 주면되고 이걸 15번 반복하면 된다. 함수 코드는 아래와 같다. <br>

시간도 오래 걸리지 않았는데 10만개 돌리는데 1분 이내로 됐던 것 같다.

```typescript
function generateGeohash(lat: number, lng: number): string {
    let x1 = 124.43994112;
    let x2 = 132.17495859;
    let y1 = 31.99775289;
    let y2 = 39.73277036;

    let midY = (y1 + y2) / 2;
    let midX = (x1 + x2) / 2;

    let markerId = "";
    let i = 0;
    while (i < 15) {
        let unit = "";
        if (lat <= midY) {
            unit = "0";
            y2 = midY;
        } else {
            unit = "1";
            y1 = midY;
        }

        if (lng <= midX) {
            unit += "0";
            x2 = midX;
        } else {
            unit += "1";
            x1 = midX;
        }
        midY = (y1 + y2) / 2;
        midX = (x1 + x2) / 2;

        markerId += parseInt(unit, 2).toString();

        i += 1;
    }

    return markerId;
}
```

<br>

## 지도 축척에 따른 클러스터링

지도는 축척(레벨)에 따라 클러스터링으로 묶이는 범위도 달라진다. <br>
이때도 지오해시 값을 이용해서 클러스터링을 할 수 있다.
지오해시 값이 15자리라면 15개 레벨마다의 위치 값을 표시 할 수 있다.

예를 들어 2개의 의원의 지오해시 값이 "012301230123012"과 "012301230123013"라고 보자.

지도를 가장 축소한 레벨 1일 때 2개 의원의 지오해시 값은 "0"이다. <br>
레벨2의 "01" <br>
레벨3의 "012" <br>
.... <br>
마지막으로 지도를 가장 확대된 레벨15는 "012301230123012", "012301230123013"이다.

즉, 두 의원은 레벨1~14에서는 같은 지오해시 값이라 같은 클러스터링으로 묶이지만 <br>
15번째 레벨에서는 지오해시 값이 다르므로 함께 클러스터링되지 않는다.

 <br>

## 결론

지오해시 값 하나만 있으면 모든 레벨별로 적용할 수 있는 꽤나 괜찮은 클러스터링을 구현할 수 있다. <br>
단 지오해시 값의 자리수라던지 어떤식으로 등분을 할 것인지는 서비스 특징에 따라 고민해볼 필요가 있을 것 같다. 끗!<br>
